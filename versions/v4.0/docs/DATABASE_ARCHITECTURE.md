# üóÑÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SPIN Training Bot

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#—Ç–∏–ø-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ–µ–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–ª–æ–µ–≤)
- [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î](#–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è-–±–¥)
- [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-–∫–æ–¥–µ)
- [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## üéØ –û–±–∑–æ—Ä

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **SQLAlchemy —Å async –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–≤–µ –°–£–ë–î:

- **PostgreSQL** (production) - —á–µ—Ä–µ–∑ `asyncpg`
- **SQLite** (development/testing) - —á–µ—Ä–µ–∑ `aiosqlite`

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

- ‚úÖ **Async/await** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
- ‚úÖ **Multi-bot –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –±–æ—Ç–∞–º
- ‚úÖ **–ö—Ä–æ—Å—Å-–±–æ—Ç –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è** - –æ–±—â–∏–µ XP, level, badges
- ‚úÖ **Repository pattern** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- ‚úÖ **Service layer** - –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API –¥–ª—è bot.py

---

## üóÑÔ∏è –¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ë–î

–¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `DATABASE_URL`:

```python
# database/database.py
DATABASE_URL = os.getenv('DATABASE_URL', 'sqlite+aiosqlite:///./spin_bot.db')
```

### –í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

#### 1. SQLite (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
```bash
DATABASE_URL=sqlite+aiosqlite:///./spin_bot.db
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –§–∞–π–ª–æ–≤–∞—è –ë–î (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ event loop –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### 2. PostgreSQL (production)
```bash
DATABASE_URL=postgresql://user:password@host:5432/dbname
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ë–î (Railway, Heroku, etc.)
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ URL

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ URL

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∏ 27-31)
if DATABASE_URL.startswith('postgres://'):
    DATABASE_URL = DATABASE_URL.replace('postgres://', 'postgresql://', 1)
elif DATABASE_URL.startswith('postgresql://'):
    DATABASE_URL = DATABASE_URL.replace('postgresql://', 'postgresql+asyncpg://', 1)
```

**–õ–æ–≥–∏–∫–∞:**
- `postgres://` ‚Üí `postgresql://` (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Railway/Heroku)
- `postgresql://` ‚Üí `postgresql+asyncpg://` (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ async –¥—Ä–∞–π–≤–µ—Ä–∞)

---

## üîå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Engine

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∏ 34-40)
engine = create_async_engine(
    DATABASE_URL,
    echo=False,              # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
    future=True,             # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQLAlchemy 2.0 API
    pool_pre_ping=True,     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    pool_recycle=3600,      # –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π —á–∞—Å
)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `pool_pre_ping=True` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "connection lost" –æ—à–∏–±–∫–∏)
- `pool_recycle=3600` - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3600 —Å–µ–∫—É–Ω–¥ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã)

### 2. –°–æ–∑–¥–∞–Ω–∏–µ Session Factory

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∏ 45-49)
async_session_maker = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False  # –û–±—ä–µ–∫—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–æ—Å–ª–µ commit
)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `expire_on_commit=False` - –æ–±—ä–µ–∫—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–æ—Å–ª–µ commit (—É–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏)

### 3. Context Manager –¥–ª—è —Å–µ—Å—Å–∏–π

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∏ 71-103)
@asynccontextmanager
async def get_session() -> AsyncGenerator[AsyncSession, None]:
    async with async_session_maker() as session:
        try:
            yield session
            await session.commit()  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
        except Exception as e:
            await session.rollback()  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
            raise
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
async with get_session() as session:
    # –í–∞—à–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
    user = await session.get(User, user_id)
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ–µ–≤

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  bot.py (Telegram handlers)                              ‚îÇ
‚îÇ  - handle_message()                                       ‚îÇ
‚îÇ  - start_command()                                       ‚îÇ
‚îÇ  - process_question()                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  services/user_service_db.py (UserServiceDB)            ‚îÇ
‚îÇ  - –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏                    ‚îÇ
‚îÇ  - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç sync ‚Üí async                            ‚îÇ
‚îÇ  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç DatabaseService                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  services/database_service.py (DatabaseService)         ‚îÇ
‚îÇ  - –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API                                   ‚îÇ
‚îÇ  - get_user_session()                                    ‚îÇ
‚îÇ  - save_session()                                         ‚îÇ
‚îÇ  - add_xp_and_check_level_up()                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  database/repositories/*.py (Repositories)              ‚îÇ
‚îÇ  - UserRepository                                        ‚îÇ
‚îÇ  - SessionRepository                                     ‚îÇ
‚îÇ  - BadgeRepository                                       ‚îÇ
‚îÇ  - SubscriptionRepository                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  database/database.py (get_session)                     ‚îÇ
‚îÇ  - Context manager –¥–ª—è —Å–µ—Å—Å–∏–π                            ‚îÇ
‚îÇ  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit/rollback                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  database/base_models.py (SQLAlchemy Models)            ‚îÇ
‚îÇ  - User                                                  ‚îÇ
‚îÇ  - BotSession                                            ‚îÇ
‚îÇ  - UserBadge                                             ‚îÇ
‚îÇ  - Subscription                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL / SQLite                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–æ–µ–≤:

#### 1. **bot.py** (Telegram handlers)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `UserServiceDB` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
- –ù–µ –∑–Ω–∞–µ—Ç –æ –¥–µ—Ç–∞–ª—è—Ö –ë–î

#### 2. **UserServiceDB** (–ê–¥–∞–ø—Ç–µ—Ä)
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç sync API –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç sync –≤—ã–∑–æ–≤—ã –≤ async —á–µ—Ä–µ–∑ `nest_asyncio`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `DatabaseService` –≤–Ω—É—Ç—Ä–∏

#### 3. **DatabaseService** (–í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API)
- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—â–∏–µ workflow (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + —Å–µ—Å—Å–∏–∏)

#### 4. **Repositories** (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
- –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
- –û–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π = –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SQLAlchemy ORM

#### 5. **Models** (SQLAlchemy Models)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü
- Relationships –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üìä –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

#### 1. **users** - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

```python
class User(Base):
    __tablename__ = "users"
    
    id: Mapped[int]                    # Primary Key
    telegram_id: Mapped[int]            # Unique, Indexed
    username: Mapped[Optional[str]]
    first_name: Mapped[Optional[str]]
    last_name: Mapped[Optional[str]]
    
    # –ö—Ä–æ—Å—Å-–±–æ—Ç –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è
    total_xp: Mapped[int] = 0           # –û–±—â–∏–π XP –∏–∑ –≤—Å–µ—Ö –±–æ—Ç–æ–≤
    level: Mapped[int] = 1              # –û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å
    
    # Legacy —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_trainings: Mapped[int] = 0
    total_score: Mapped[int] = 0
    
    # Relationships
    badges: Mapped[list["UserBadge"]]
    subscriptions: Mapped[list["Subscription"]]
    bot_sessions: Mapped[list["BotSession"]]
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤. –•—Ä–∞–Ω–∏—Ç –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

#### 2. **bot_sessions** - –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π –ø–æ –±–æ—Ç–∞–º

```python
class BotSession(Base):
    __tablename__ = "bot_sessions"
    
    id: Mapped[int]
    user_id: Mapped[int]                # FK ‚Üí users.id
    bot_name: Mapped[str]               # "spin_bot", "quiz_bot" (indexed)
    
    # JSON –¥–∞–Ω–Ω—ã–µ
    session_data: Mapped[dict]          # –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è
    stats_data: Mapped[dict]            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞
    
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]        # Auto-update
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç bot-specific –¥–∞–Ω–Ω—ã–µ. –ö–∞–∂–¥—ã–π –±–æ—Ç –∏–º–µ–µ—Ç —Å–≤–æ—é –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–∏–º–µ—Ä session_data:**
```json
{
  "question_count": 5,
  "clarity_level": 75,
  "chat_state": "in_progress",
  "per_type_counts": {"situation": 2, "problem": 3},
  "case_data": {"client": "TechCorp", "product": "CRM"},
  "last_client_response": "–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å 5 –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏..."
}
```

#### 3. **user_badges** - –ö—Ä–æ—Å—Å-–±–æ—Ç –±–µ–π–¥–∂–∏

```python
class UserBadge(Base):
    __tablename__ = "user_badges"
    
    id: Mapped[int]
    user_id: Mapped[int]                # FK ‚Üí users.id
    badge_type: Mapped[str]             # "spin_master", "quiz_guru"
    earned_in_bot: Mapped[str]          # "spin_bot", "quiz_bot"
    earned_at: Mapped[datetime]
    metadata: Mapped[Optional[dict]]    # JSON –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë–µ–π–¥–∂–∏, –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≤ –ª—é–±–æ–º –±–æ—Ç–µ, –≤–∏–¥–Ω—ã –≤–æ –≤—Å–µ—Ö –±–æ—Ç–∞—Ö.

#### 4. **subscriptions** - –ü–æ–¥–ø–∏—Å–∫–∏

```python
class Subscription(Base):
    __tablename__ = "subscriptions"
    
    id: Mapped[int]
    user_id: Mapped[int]                # FK ‚Üí users.id
    subscription_type: Mapped[SubscriptionType]  # MONTH, YEAR, CREDITS
    start_date: Mapped[datetime]
    end_date: Mapped[Optional[datetime]]
    is_active: Mapped[bool]
    
    # –î–ª—è –∫—Ä–µ–¥–∏—Ç–æ–≤
    credits_total: Mapped[Optional[int]]
    credits_left: Mapped[Optional[int]]
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º.

#### 5. **free_trainings** - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏

```python
class FreeTraining(Base):
    __tablename__ = "free_trainings"
    
    id: Mapped[int]
    user_id: Mapped[int]                # FK ‚Üí users.id
    trainings_left: Mapped[int]         # –°—á–µ—Ç—á–∏–∫
    source: Mapped[FreeTrainingSource]  # CHANNEL, PROMOCODE, ADMIN
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

#### 6. **training_history** - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (SPIN-specific)

```python
class TrainingHistory(Base):
    __tablename__ = "training_history"
    
    id: Mapped[int]
    user_id: Mapped[int]
    telegram_id: Mapped[int]            # Indexed
    training_date: Mapped[datetime]     # Indexed
    
    # –ú–µ—Ç—Ä–∏–∫–∏
    total_score: Mapped[int]
    clarity_level: Mapped[int]
    question_count: Mapped[int]
    
    # JSON –¥–∞–Ω–Ω—ã–µ
    per_type_counts: Mapped[dict]
    case_data: Mapped[dict]
    session_snapshot: Mapped[dict]
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (bot-specific –º–æ–¥–µ–ª—å).

---

## üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î

### 1. –í—ã–∑–æ–≤ –≤ bot.py

```python
# bot.py (—Å—Ç—Ä–æ–∫–∏ 642-646)
async def initialize_database():
    """Initialize database asynchronously."""
    logger.info("üîÑ Initializing database...")
    await init_db()
    logger.info("‚úÖ Database initialized")
```

### 2. –í—ã–∑–æ–≤ –≤ main()

```python
# bot.py (—Å—Ç—Ä–æ–∫–∏ 707-716)
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º loop
try:
    loop.run_until_complete(initialize_database())
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")
    print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {e}")
    remove_pid_file()
    return
```

### 3. –§—É–Ω–∫—Ü–∏—è init_db()

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∏ 52-68)
async def init_db() -> None:
    """
    Initialize database: create all tables.
    Should be called once at application startup.
    """
    logger.info("üîµ init_db() STARTED")
    try:
        async with engine.begin() as conn:
            logger.info("üîµ Creating tables...")
            await conn.run_sync(Base.metadata.create_all)
            logger.info("üîµ Tables created successfully")
        logger.info("‚úÖ Database initialized successfully")
    except Exception as e:
        logger.error(f"üî¥ ERROR in init_db(): {e}")
        raise
    finally:
        logger.info("üîµ init_db() FINISHED")
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —á–µ—Ä–µ–∑ `engine.begin()`
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `Base.metadata.create_all` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
3. –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–¥–µ–ª–µ–π –∏–∑ `base_models.py`

### 4. –ó–∞–∫—Ä—ã—Ç–∏–µ –ë–î –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

```python
# bot.py (—Å—Ç—Ä–æ–∫–∏ 649-665)
async def cleanup_resources():
    """Cleanup resources on shutdown."""
    logger.info("üîÑ Cleaning up resources...")
    
    try:
        await close_db()
        logger.info("‚úÖ Database closed")
    except Exception as e:
        logger.error(f"Error closing database: {e}")
```

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∏ 106-118)
async def close_db() -> None:
    """
    Close database connection.
    Should be called on application shutdown.
    """
    logger.info("üîµ close_db() STARTED")
    try:
        await engine.dispose()  # –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        logger.info("‚úÖ Database connection closed")
    except Exception as e:
        logger.error(f"üî¥ ERROR in close_db(): {e}")
    finally:
        logger.info("üîµ close_db() FINISHED")
```

---

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### 1. –í bot.py (—á–µ—Ä–µ–∑ UserServiceDB)

```python
# bot.py (—Å—Ç—Ä–æ–∫–∞ 70)
user_service = UserServiceDB(bot_name="spin_bot")

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
# bot.py (—Å—Ç—Ä–æ–∫–∞ 272)
user_data = user_service.get_user_data(user_id)

# bot.py (—Å—Ç—Ä–æ–∫–∞ 545)
user_service.save_user_data(user_id, session, user_data['stats'])
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Sync API (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ async —á–µ—Ä–µ–∑ `nest_asyncio`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `DatabaseService`

### 2. –í modules/payments (–Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ get_session)

```python
# modules/payments/handlers.py (—Å—Ç—Ä–æ–∫–∞ 13)
from database.database import get_session

# modules/payments/handlers.py (—Å—Ç—Ä–æ–∫–∞ 46)
async with get_session() as session:
    # –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏
    from database.repositories import UserRepository
    user_repo = UserRepository(session)
    user = await user_repo.get_by_telegram_id(telegram_id)
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Async API (–Ω–∞—Ç–∏–≤–Ω—ã–π async/await)
- –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

### 3. –í services/database_service.py (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API)

```python
# services/database_service.py (—Å—Ç—Ä–æ–∫–∏ 88-109)
async with get_session() as session:
    user_repo = UserRepository(session)
    session_repo = SessionRepository(session)
    
    # Get or create user
    user = await user_repo.get_or_create(
        telegram_id=telegram_id,
        username=username,
        first_name=first_name
    )
    
    # Get or create bot session
    bot_session = await session_repo.get_or_create(
        user_id=user.id,
        bot_name=self.bot_name
    )
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π API –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–µ—Å—Å–∏–∏

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–æ–∫ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
1. bot.py: handle_message()
   ‚Üì
2. user_service.get_user_data(user_id)
   ‚Üì
3. UserServiceDB._run_async()
   ‚Üì
4. DatabaseService.get_user_session()
   ‚Üì
5. get_session() ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é
   ‚Üì
6. UserRepository.get_or_create() ‚Üí –ø–æ–ª—É—á–∞–µ—Ç/—Å–æ–∑–¥–∞–µ—Ç User
   ‚Üì
7. SessionRepository.get_or_create() ‚Üí –ø–æ–ª—É—á–∞–µ—Ç/—Å–æ–∑–¥–∞–µ—Ç BotSession
   ‚Üì
8. –í–æ–∑–≤—Ä–∞—Ç {'user': {...}, 'session': {...}, 'stats': {...}}
   ‚Üì
9. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit —á–µ—Ä–µ–∑ get_session()
```

### –ü–æ—Ç–æ–∫ 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```
1. bot.py: process_question()
   ‚Üì
2. user_service.save_user_data(user_id, session_data, stats_data)
   ‚Üì
3. UserServiceDB._run_async()
   ‚Üì
4. DatabaseService.save_session()
   ‚Üì
5. get_session() ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é
   ‚Üì
6. SessionRepository.update_both() ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç session_data –∏ stats_data
   ‚Üì
7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit —á–µ—Ä–µ–∑ get_session()
```

### –ü–æ—Ç–æ–∫ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (modules/payments)

```
1. modules/payments/handlers.py: check_subscription_callback()
   ‚Üì
2. get_session() ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é
   ‚Üì
3. SubscriptionRepository.check_access() ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
   ‚Üì
4. SubscriptionRepository.get_active_subscription() ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
   ‚Üì
5. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   ‚Üì
6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit —á–µ—Ä–µ–∑ get_session()
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# –í bot.py
user_data = user_service.get_user_data(user_id)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
    'session': {
        'question_count': 5,
        'clarity_level': 75,
        'chat_state': 'in_progress',
        ...
    },
    'stats': {
        'total_trainings': 10,
        'best_score': 185,
        ...
    }
}
```

### –ü—Ä–∏–º–µ—Ä 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```python
# –í bot.py
user_data = user_service.get_user_data(user_id)
user_data['session']['question_count'] = 6
user_data['session']['clarity_level'] = 80

user_service.save_user_data(
    user_id,
    user_data['session'],
    user_data['stats']
)
```

### –ü—Ä–∏–º–µ—Ä 3: –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏

```python
# –í modules/payments/handlers.py
from database.database import get_session
from database.repositories import UserRepository, SubscriptionRepository

async with get_session() as session:
    user_repo = UserRepository(session)
    sub_repo = SubscriptionRepository(session)
    
    # –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await user_repo.get_by_telegram_id(telegram_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
    subscription = await sub_repo.get_active_subscription(telegram_id)
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞
```

### –ü—Ä–∏–º–µ—Ä 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ XP –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ level up

```python
# –í services/database_service.py
result = await db_service.add_xp_and_check_level_up(
    telegram_id=123456,
    xp_to_add=150,
    levels_config=[
        {"level": 1, "min_xp": 0},
        {"level": 2, "min_xp": 100},
        {"level": 3, "min_xp": 300}
    ]
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
    'leveled_up': True,
    'old_level': 1,
    'new_level': 2,
    'total_xp': 150
}
```

### –ü—Ä–∏–º–µ—Ä 5: –í—ã–¥–∞—á–∞ –±–µ–π–¥–∂–∞

```python
# –í services/database_service.py
awarded = await db_service.award_badge(
    telegram_id=123456,
    badge_type="spin_master",
    metadata={"score": 185, "date": "2025-01-15"}
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: True (–±–µ–π–¥–∂ –≤—ã–¥–∞–Ω) –∏–ª–∏ False (—É–∂–µ –µ—Å—Ç—å)
```

---

## üîç –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

### 1. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö —á–µ—Ä–µ–∑ `get_session()`:

```python
async with get_session() as session:
    # –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–¥–µ—Å—å - –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
    user = await user_repo.get_or_create(...)
    session_data = await session_repo.update(...)
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã—Ö–æ–¥–µ
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

### 2. –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –±–æ—Ç–∞–º

–ö–∞–∂–¥—ã–π –±–æ—Ç –∏–º–µ–µ—Ç —Å–≤–æ—é –∑–∞–ø–∏—Å—å –≤ `bot_sessions`:

```python
# SPIN –±–æ—Ç
bot_session_spin = await session_repo.get_or_create(
    user_id=user.id,
    bot_name="spin_bot"
)

# Quiz –±–æ—Ç (—Ç–æ—Ç –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–æ –¥—Ä—É–≥–∞—è —Å–µ—Å—Å–∏—è)
bot_session_quiz = await session_repo.get_or_create(
    user_id=user.id,
    bot_name="quiz_bot"
)
```

### 3. –ö—Ä–æ—Å—Å-–±–æ—Ç –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è

XP –∏ level —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü–µ `users`:

```python
# SPIN –±–æ—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç XP
await user_repo.add_xp(telegram_id, 100)

# Quiz –±–æ—Ç –≤–∏–¥–∏—Ç –¢–û–¢ –ñ–ï XP
user = await user_repo.get_by_telegram_id(telegram_id)
print(user.total_xp)  # 100 (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤)
```

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

```python
# –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
user = await user_repo.get_or_create(
    telegram_id=123456,
    username="johndoe",
    first_name="John"
)
```

### 5. JSON –ø–æ–ª—è

`session_data` –∏ `stats_data` —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ JSON:

- **PostgreSQL**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø `JSONB` (–±–∏–Ω–∞—Ä–Ω—ã–π JSON)
- **SQLite**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø `TEXT` (—Ç–µ–∫—Å—Ç–æ–≤—ã–π JSON)

SQLAlchemy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Python dict ‚Üî JSON.

---

## üõ†Ô∏è –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ SQL –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# database/database.py (—Å—Ç—Ä–æ–∫–∞ 36)
engine = create_async_engine(
    DATABASE_URL,
    echo=True,  # –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
    ...
)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ë–î –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
from database.database import engine

async def test_connection():
    async with engine.connect() as conn:
        result = await conn.execute(text("SELECT 1"))
        print(result.scalar())  # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: 1
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö

**SQLite:**
```bash
sqlite3 spin_bot.db
.tables
SELECT * FROM users;
```

**PostgreSQL:**
```bash
psql $DATABASE_URL
\dt
SELECT * FROM users;
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–æ–µ API —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:** `database/README.md`
- **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `database/README.md` (—Ä–∞–∑–¥–µ–ª Examples)
- **–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö:** `database/base_models.py` (docstrings)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** `scripts/migrate_from_json.py`

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-01-16*

