# üóÑÔ∏è –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

### –í—ã–ø–æ–ª–Ω–µ–Ω–æ 100% –¢–ó:
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ database/ —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ –ú–æ–¥–µ–ª–∏ –ë–î (User, UserBadge, BotSession, Subscription, Payment, etc.)
- ‚úÖ Repositories —Å–ª–æ–π (UserRepository, BadgeRepository, SessionRepository, SubscriptionRepository)
- ‚úÖ DatabaseService - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ bot.py —á–µ—Ä–µ–∑ UserServiceDB
- ‚úÖ –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ JSON (scripts/migrate_from_json.py)
- ‚úÖ REQUIREMENTS.txt –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ .env.example —Å–æ–∑–¥–∞–Ω
- ‚úÖ database/README.md —Å–æ–∑–¥–∞–Ω
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

---

## üß™ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (9 —à—Ç—É–∫):
```
‚úÖ users             - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚úÖ user_badges       - –ö—Ä–æ—Å—Å-–±–æ—Ç –±–µ–π–¥–∂–∏
‚úÖ bot_sessions      - –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π –ø–æ –±–æ—Ç–∞–º
‚úÖ subscriptions     - –ü–æ–¥–ø–∏—Å–∫–∏
‚úÖ payments          - –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
‚úÖ promocodes        - –ü—Ä–æ–º–æ–∫–æ–¥—ã
‚úÖ promocode_usage   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
‚úÖ free_trainings    - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
‚úÖ training_history  - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ SPIN
```

### –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏:
```
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚úÖ DatabaseService —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏
‚úÖ XP –∏ Level up –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è
‚úÖ –°–∏—Å—Ç–µ–º–∞ –±–µ–π–¥–∂–µ–π
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ë–î
```

---

## üöÄ –ó–ê–ü–£–°–ö –ë–û–¢–ê

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (SQLite):

```bash
# 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å .env.sqlite –≤ .env
cp .env.sqlite .env

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –ë–î
source venv/bin/activate
python test_database.py

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python bot.py
```

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (PostgreSQL –Ω–∞ Railway):

```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ .env —Å–æ–¥–µ—Ä–∂–∏—Ç DATABASE_URL —Å PostgreSQL
cat .env | grep DATABASE_URL
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: DATABASE_URL=postgresql://...

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å asyncpg (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
pip install asyncpg>=0.30.0

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python bot.py
```

---

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:

```
database/
‚îú‚îÄ‚îÄ README.md                # üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ database.py              # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îú‚îÄ‚îÄ base_models.py           # –û–±—â–∏–µ –º–æ–¥–µ–ª–∏ (User, UserBadge, etc.)
‚îú‚îÄ‚îÄ bot_models.py            # SPIN-specific (TrainingHistory)
‚îî‚îÄ‚îÄ repositories/
    ‚îú‚îÄ‚îÄ user_repository.py
    ‚îú‚îÄ‚îÄ badge_repository.py
    ‚îú‚îÄ‚îÄ session_repository.py
    ‚îî‚îÄ‚îÄ subscription_repository.py

services/
‚îú‚îÄ‚îÄ database_service.py      # –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API
‚îî‚îÄ‚îÄ user_service_db.py       # –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è bot.py

scripts/
‚îî‚îÄ‚îÄ migrate_from_json.py     # –ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ JSON

test_database.py             # üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
DB_SETUP_GUIDE.md            # üìñ –≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

.env                         # PostgreSQL (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)
.env.sqlite                  # SQLite (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
.env.postgres                # –ë—ç–∫–∞–ø PostgreSQL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### .env –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (SQLite):

```bash
BOT_TOKEN=your_bot_token
OPENAI_API_KEY=your_key
DATABASE_URL=sqlite+aiosqlite:///./spin_bot_test.db
BOT_NAME=spin_bot
```

### .env –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (PostgreSQL):

```bash
BOT_TOKEN=your_bot_token
OPENAI_API_KEY=your_key
DATABASE_URL=postgresql://postgres:password@postgres.railway.internal:5432/railway
BOT_NAME=spin_bot
```

---

## üêõ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞ 1: metadata - –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è
**–û—à–∏–±–∫–∞:** `Attribute name 'metadata' is reserved when using the Declarative API`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ `UserBadge.metadata` ‚Üí `UserBadge.badge_metadata`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ repositories –∏ services

### –ü—Ä–æ–±–ª–µ–º–∞ 2: get_session() –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ context manager
**–û—à–∏–±–∫–∞:** `'async_generator' object does not support the asynchronous context manager protocol`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@asynccontextmanager`
- ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω `from contextlib import asynccontextmanager`

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ú–û–î–£–õ–Ø

### –ö—Ä–æ—Å—Å-–±–æ—Ç –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è:

```
User (–û–ë–©–ò–ô –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤)
‚îú‚îÄ‚îÄ telegram_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
‚îú‚îÄ‚îÄ total_xp     (XP –∏–∑ –í–°–ï–• –±–æ—Ç–æ–≤)
‚îú‚îÄ‚îÄ level        (–û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å)
‚îî‚îÄ‚îÄ badges       (–ë–µ–π–¥–∂–∏ –∏–∑ –≤—Å–µ—Ö –±–æ—Ç–æ–≤)

BotSession (–ò–ó–û–õ–ò–†–û–í–ê–ù–û –ø–æ –±–æ—Ç–∞–º)
‚îú‚îÄ‚îÄ bot_name = "spin_bot"
‚îú‚îÄ‚îÄ session_data (SPIN-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
‚îî‚îÄ‚îÄ stats_data   (SPIN-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

BotSession (–ò–ó–û–õ–ò–†–û–í–ê–ù–û –ø–æ –±–æ—Ç–∞–º)
‚îú‚îÄ‚îÄ bot_name = "quiz_bot"
‚îú‚îÄ‚îÄ session_data (Quiz-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
‚îî‚îÄ‚îÄ stats_data   (Quiz-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
```

**–ö–ª—é—á–µ–≤–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–≥—Ä–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ—Ç–æ–≤, –∏ –µ–≥–æ XP/level/badges –±—É–¥—É—Ç –û–ë–©–ò–ú–ò, –Ω–æ —Å–µ—Å—Å–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–´–ú–ò.

---

## üéØ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –í –î–†–£–ì–ò–• –ë–û–¢–ê–•

### –®–∞–≥ 1: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å

```bash
cp -r database/ /path/to/new_bot/
cp services/database_service.py /path/to/new_bot/services/
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env

```bash
DATABASE_URL=postgresql://...  # –∏–ª–∏ sqlite+aiosqlite://...
BOT_NAME=my_new_bot            # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –±–æ—Ç–∞
```

### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

```python
from database import init_db, close_db
from services.database_service import DatabaseService

async def main():
    await init_db()

    db_service = DatabaseService(bot_name="my_new_bot")
    user_data = await db_service.get_user_session(telegram_id)

    # user_data['user'] - –û–ë–©–ò–ô –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (XP, level, badges)
    # user_data['session'] - –°–µ—Å—Å–∏—è –¥–ª—è "my_new_bot"
    # user_data['stats'] - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è "my_new_bot"

    await close_db()
```

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `database/README.md`
- **–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** `V4_INTEGRATION_GUIDE.md`
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** `ARCHITECTURE_ANALYSIS.md`
- **–ò—Ç–æ–≥–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:** `REFACTORING_SUMMARY.md`

---

## ‚úÖ –ß–ï–ö-–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [x] database/README.md —Å–æ–∑–¥–∞–Ω
- [x] test_database.py —Å–æ–∑–¥–∞–Ω –∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [x] .env.sqlite –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞
- [x] –í—Å–µ 9 —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] XP, level, badges —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] BotSession –∏–∑–æ–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] TrainingHistory —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω:
- [x] .env —Å PostgreSQL –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] asyncpg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: `pip install asyncpg>=0.30.0`)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—É—Å–∫ –Ω–∞ Railway (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)

---

## üö® –í–ê–ñ–ù–´–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .env.sqlite** (SQLite –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ë–î)
- **–ö–æ–º–∞–Ω–¥–∞:** `cp .env.sqlite .env && python bot.py`

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .env —Å PostgreSQL** (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è Railway)
- **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä–∞–π–≤–µ—Ä:** `pip install asyncpg>=0.30.0`
- **–ö–æ–º–∞–Ω–¥–∞:** `python bot.py`

### –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
- **–ï—Å–ª–∏ –µ—Å—Ç—å users_data.json:** `python scripts/migrate_from_json.py users_data.json`
- **–ï—Å–ª–∏ –ë–î –ø—É—Å—Ç–∞—è:** –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

---

## üéâ –ò–¢–û–ì–û

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¢–ó: **100%**

**–°–æ–∑–¥–∞–Ω–æ:**
- 9 –º–æ–¥–µ–ª–µ–π –ë–î
- 4 Repository –∫–ª–∞—Å—Å–∞
- 1 DatabaseService —Å 20+ –º–µ—Ç–æ–¥–∞–º–∏
- 1 –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
- 1 —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- 2 —Ñ–∞–π–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (README.md + —ç—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ)

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚úÖ –í—Å–µ 8 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 9 —Ç–∞–±–ª–∏—Ü
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ XP, level, badges —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ö—Ä–æ—Å—Å-–±–æ—Ç –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:** ‚úÖ **–î–ê**

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

Telegram: @TaktikaKutuzova

---

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞! üöÄ**
