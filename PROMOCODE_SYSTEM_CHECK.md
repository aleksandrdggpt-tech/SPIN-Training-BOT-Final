# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò

### ‚ùå –ß–¢–û –û–¢–°–£–¢–°–¢–í–£–ï–¢

#### 1. ‚ùå –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞ `/admin` –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ bot.py

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `create_promocode()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `modules/payments/promocodes.py`
- ‚úÖ –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `get_admin_promo_keyboard()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ùå –ù–æ –≤ `bot.py` –ù–ï–¢ –∫–æ–º–∞–Ω–¥—ã `/admin`
- ‚ùå Handlers –ù–ï –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ `register_payment_handlers()`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
```python
# –í bot.py –¥–æ–±–∞–≤–∏—Ç—å:
from modules.payments.handlers import register_payment_handlers

def main():
    # ...
    register_payment_handlers(application)  # ‚Üê –≠–¢–û–ì–û –ù–ï–¢!
    # ...
```

---

#### 2. ‚ùå Google Sheets —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ùå –§–∞–π–ª–∞ `scripts/sync_to_sheets.py` –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢
- ‚ùå –ù–µ—Ç –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚ùå –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google API

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
–°–æ–∑–¥–∞—Ç—å `scripts/sync_to_sheets.py` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

#### 3. ‚ö†Ô∏è –ü–æ–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

**–í–∞—à–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ:**
```sql
CREATE TABLE promocodes (
    source TEXT NOT NULL,
    assigned_user_id BIGINT,
    ...
);
```

**–ß—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å:**
```python
class Promocode(Base):
    code = ...
    type = PromocodeType  # TRAININGS, FREE_MONTH, CREDITS
    value = ...
    max_uses = ...
    expires_at = ...
    # –ù–ï–¢ source
    # –ù–ï–¢ assigned_user_id
```

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `source` –∏ `assigned_user_id` –≤ –º–æ–¥–µ–ª—å `Promocode`

---

### ‚úÖ –ß–¢–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ö–û–†–†–ï–ö–¢–ù–û

#### 1. ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```python
# –ö–æ–º–∞–Ω–¥–∞: /promo WINTER2025
async def process_promocode(update: Update, context):
    code = update.message.text.strip()
    success, message = await activate_promocode(code, telegram_id, session)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:**
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
- ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω? (–Ω–µ –∏—Å—Ç—ë–∫)
- ‚úÖ –ï—Å—Ç—å –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π?
- ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º?

**–ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ `assigned_user_id` (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥)

---

#### 2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

```python
# –í activate_promocode():
if promo.type == PromocodeType.TRAININGS.value:
    await add_free_trainings(...)  # ‚úÖ
elif promo.type == PromocodeType.FREE_MONTH.value:
    await create_subscription(...)  # ‚úÖ
elif promo.type == PromocodeType.CREDITS.value:
    await create_subscription(...)  # ‚úÖ
```

---

#### 3. ‚úÖ –°—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π

```python
# –í activate_promocode():
promo.current_uses += 1  # ‚úÖ
session.add(PromocodeUsage(...))  # ‚úÖ –ó–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
```

---

### üìã –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------|--------|-------------|
| –ê–¥–º–∏–Ω /admin –∫–æ–º–∞–Ω–¥–∞ | ‚ùå | –ù–ï –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ bot.py |
| –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ –±–æ—Ç–µ | ‚ö†Ô∏è | –ï—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è, –Ω–µ—Ç UI |
| –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ |
| –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã |
| –ü–æ–ª–µ `source` | ‚ùå | –ù–µ—Ç –≤ –º–æ–¥–µ–ª–∏ |
| –ü–æ–ª–µ `assigned_user_id` | ‚ùå | –ù–µ—Ç –≤ –º–æ–¥–µ–ª–∏ |
| –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π | ‚úÖ | –ï—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ PromocodeUsage |
| Google Sheets —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | ‚ùå | –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û |
| –°—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π | ‚úÖ | current_uses++ |
| –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

---

## üîß –ß–¢–û –ù–£–ñ–ù–û –î–û–î–ï–õ–ê–¢–¨

### 1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /admin –≤ bot.py

```python
# –í bot.py –¥–æ–±–∞–≤–∏—Ç—å:
from modules.payments.handlers import register_payment_handlers

def main():
    # ...
    register_payment_handlers(application)  # ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ß–ö–£
    # ...
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å Promocode

```python
# –í database/base_models.py:
class Promocode(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    
    source: Mapped[str] = mapped_column(String(50), nullable=False, default="manual")  # ‚Üê –î–û–ë–ê–í–ò–¢–¨
    assigned_user_id: Mapped[Optional[int]] = mapped_column(Integer, nullable=True)  # ‚Üê –î–û–ë–ê–í–ò–¢–¨
```

### 3. –°–æ–∑–¥–∞—Ç—å sync_to_sheets.py

```python
# scripts/sync_to_sheets.py
import gspread
# ...
async def sync_promocodes():
    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ Google Sheets
    pass
```

### 4. –û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:
```python
if promo.assigned_user_id:
    if promo.assigned_user_id != user.id:
        return {"valid": False, "error": "‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–ª—è –≤–∞—Å"}
```

---

## üéØ –í–´–í–û–î

**–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ 70%:**

‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç:**
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è (–∏—Å—Ç—ë–∫ —Å—Ä–æ–∫, –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π, —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏/–¥–æ—Å—Ç—É–ø–∞
- –°—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
- –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π

‚ùå **–ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–∫–æ–º–∞–Ω–¥–∞ /admin –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞)
- Google Sheets —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—Ñ–∞–π–ª–∞ –Ω–µ—Ç)
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã (–Ω–µ—Ç assigned_user_id)
- Source –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–Ω–µ—Ç –ø–æ–ª—è source)

‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ:**
- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è, –Ω–æ –Ω–µ—Ç UI –¥–ª—è –∞–¥–º–∏–Ω–∞ –≤ –±–æ—Ç–µ)

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ —Ä–∞–±–æ—Ç—É –Ω—É–∂–Ω–æ:**
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å `register_payment_handlers()` –≤ bot.py (5 –º–∏–Ω—É—Ç)
2. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `source` –∏ `assigned_user_id` –≤ –º–æ–¥–µ–ª—å (10 –º–∏–Ω—É—Ç)
3. –°–æ–∑–¥–∞—Ç—å Google Sheets —Å–∫—Ä–∏–ø—Ç (30 –º–∏–Ω—É—Ç)

**–ò–¢–û–ì–û: ~45 –º–∏–Ω—É—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏**


