# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
Error binding parameter 2: type 'PromocodeType' is not supported
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

SQLite –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç enum —Ç–∏–ø—ã –Ω–∞–ø—Ä—è–º—É—é. –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `Enum(PromocodeType)` –≤ –º–æ–¥–µ–ª–∏ Promocode, SQLAlchemy –ø—ã—Ç–∞–ª—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å enum –æ–±—ä–µ–∫—Ç, —á—Ç–æ –≤—ã–∑–≤–∞–ª–æ –æ—à–∏–±–∫—É.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò–∑–º–µ–Ω–µ–Ω–∞ –º–æ–¥–µ–ª—å Promocode

**–§–∞–π–ª:** `database/models.py`

**–ë—ã–ª–æ:**
```python
type: Mapped[PromocodeType] = mapped_column(Enum(PromocodeType), nullable=False)
```

**–°—Ç–∞–ª–æ:**
```python
type: Mapped[str] = mapped_column(String(50), nullable=False)
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–§–∞–π–ª:** `modules/payments/promocodes.py`

**–ë—ã–ª–æ:**
```python
promo = Promocode(
    code=code,
    type=promo_type,  # Enum –æ–±—ä–µ–∫—Ç
    value=value,
    ...
)
```

**–°—Ç–∞–ª–æ:**
```python
promo = Promocode(
    code=code,
    type=promo_type.value,  # –°—Ç—Ä–æ–∫–∞: "trainings", "free_month", "credits"
    value=value,
    ...
)
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `modules/payments/promocodes.py`

–ò–∑–º–µ–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `format_promocode_info()` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:
```python
type_emoji = {
    "trainings": "üéÅ",
    "free_month": "üìÖ",
    "credits": "üíé"
}.get(promo.type, "üéüÔ∏è")
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ handlers

**–§–∞–π–ª:** `bot.py`

```python
# –°–ù–ê–ß–ê–õ–ê —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ handlers
register_payment_handlers(application)

# –ü–û–¢–û–ú –æ–±—â–∏–π handler –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
```

### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ handle_message

**–§–∞–π–ª:** `bot.py`

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ ConversationHandler
if 'promo_data' in context.user_data:
    logger.info(f"User {user_id} is in promocode creation flow, skipping handle_message")
    return
```

### 6. –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.

---

## üéØ –ò—Ç–æ–≥

–¢–µ–ø–µ—Ä—å:
1. ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Ç–∏–ø–∞
2. ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
4. ‚úÖ –í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ü–æ–ª–µ `type` —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç —Å—Ç—Ä–æ–∫—É: "trainings", "free_month" –∏–ª–∏ "credits"
- Enum `PromocodeType` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –º–∞–ø–ø–∏–Ω–≥–∞
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å SQLite –∏ PostgreSQL
- –°—Ç–∞—Ä–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ —Å–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤–∞—è

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-01-28
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

